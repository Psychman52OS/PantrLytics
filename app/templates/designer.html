{% extends "layout.html" %}
{% block title %}Designer · Inventory & Labels{% endblock %}

{% block content %}

<section class="card">
  <header class="page-header">
    <div class="page-header-text">
      <h1 class="page-title">Label Designer</h1>
      <p class="page-subtitle">
        Quick one-off labels, plus global presets used when printing items.
      </p>
    </div>
  </header>

  <!-- Quick Label card -->
  <div class="detail-grid">
    <section class="kv">
      <h2 class="card-title">Quick Label</h2>
      <p class="muted">
        Fast one-off labels that do <strong>not</strong> come from items.
        Title is big, description is smaller. No presets.
      </p>

      {% if quick_printed %}
        <p class="muted">✅ Quick label sent to printer.</p>
      {% endif %}
      {% if quick_error %}
        <p class="muted">⚠️ Print error: {{ quick_error }}</p>
      {% endif %}

      <form method="post" class="form-grid">
        <div class="field field--full">
          <label class="kv-label" for="quick_title">Title</label>
          <input
            class="input"
            id="quick_title"
            name="title"
            type="text"
            placeholder="e.g. FRAGILE"
            required
          >
        </div>

        <div class="field field--full">
          <label class="kv-label" for="quick_desc">Description</label>
          <textarea
            class="input"
            id="quick_desc"
            name="description"
            rows="2"
            placeholder="e.g. Handle with care"
          ></textarea>
        </div>

        <div class="actions field--full">
          <button
            class="btn btn-secondary"
            type="submit"
            formaction="{{ url_for('quick_label_preview') }}"
            formtarget="_blank"
          >
            Preview
          </button>
          <button
            class="btn btn-primary"
            type="submit"
            formaction="{{ url_for('quick_label_print') }}"
          >
            Print quick label
          </button>
        </div>
      </form>
    </section>

    <!-- Presets summary -->
    <aside class="detail-photo-card">
      <h2 class="card-title">How presets work</h2>
      <p class="muted">
        <strong>Item labels</strong> (when you click <em>Print Label</em> on an item)
        always use the <strong>current default preset</strong>.
      </p>
      <p class="muted">
        Create a few presets (e.g. “Freezer basic”, “Pantry detail”) and mark
        one as default. You can switch defaults any time from here.
      </p>
    </aside>
  </div>
</section>

<!-- Item label presets -->
<section class="card" style="margin-top:16px;">
  <header class="page-header">
    <div class="page-header-text">
      <h2 class="page-title">Item Label Presets</h2>
      <p class="page-subtitle">
        Global presets for printing item labels. Advanced mode: choose fields,
        font scale, QR, and basic alignment.
      </p>
    </div>
  </header>

  {% if presets %}
    <div class="card-grid" style="margin-bottom:12px; display:grid; grid-template-columns:repeat(auto-fit,minmax(280px,1fr)); gap:12px;">
      {% for p in presets %}
        <div class="card" style="padding:12px;">
          <div class="flex-between" style="align-items:flex-start;">
            <div>
              <div class="card-title" style="margin:0;">{{ p.name }}</div>
              <div class="muted" style="font-size:12px;">Media: {{ p.media }}</div>
              <div class="muted" style="font-size:12px;">Printer side: {{ (p.printer_side or 'auto')|capitalize }}</div>
            </div>
            <div>
              {% if p.is_default %}
                <span class="badge badge-success">Default</span>
              {% else %}
                <form method="post" action="{{ url_for('label_preset_default') }}">
                  <input type="hidden" name="preset_id" value="{{ p.id }}">
                  <button class="btn btn-small btn-secondary" type="submit" title="Make default">
                    Make default
                  </button>
                </form>
              {% endif %}
            </div>
          </div>
          <div class="muted" style="margin-top:6px; font-size:12px; line-height:1.4;">
            {% set fields = [] %}
            {% if p.include_name %}{% set _ = fields.append("Name") %}{% endif %}
            {% if p.include_location %}{% set _ = fields.append("Location") %}{% endif %}
            {% if p.include_bin %}{% set _ = fields.append("Bin") %}{% endif %}
            {% if p.include_qty_unit %}{% set _ = fields.append("Qty+Unit") %}{% endif %}
            {% if p.include_condition %}{% set _ = fields.append("Condition") %}{% endif %}
            {% if p.include_cook_date %}{% set _ = fields.append("Cook") %}{% endif %}
            {% if p.include_use_by %}{% set _ = fields.append("Use-by") %}{% endif %}
            {% if p.include_use_within %}{% set _ = fields.append("Use Within") %}{% endif %}
            {% if p.include_qr %}{% set _ = fields.append("QR") %}{% endif %}
            <strong>Fields:</strong> {{ fields|join(", ") }}
          </div>
          <div class="actions" style="margin-top:8px; display:flex; gap:8px; justify-content:flex-end;">
            <form method="post"
                  action="{{ url_for('label_preset_delete') }}"
                  onsubmit="return confirm('Delete this preset?');">
              <input type="hidden" name="preset_id" value="{{ p.id }}">
              <button class="btn btn-small btn-danger" type="submit">
                Delete
              </button>
            </form>
          </div>
        </div>
      {% endfor %}
    </div>
  {% else %}
    <p class="muted">
      No presets yet. Create one below.
    </p>
  {% endif %}

  <!-- Create new preset -->
  <h3 class="card-title" style="margin-top:8px;">New preset</h3>

  <form method="post" action="{{ url_for('label_preset_save') }}" class="form-grid">
    <div class="field">
      <label class="kv-label" for="preset_name">Name</label>
      <input
        class="input"
        id="preset_name"
        name="name"
        type="text"
        placeholder="e.g. Freezer basic"
        required
      >
    </div>

    <div class="field">
      <label class="kv-label" for="preset_media">Media</label>
      <select class="input" id="preset_media" name="media">
        <option value="w79h252">Small address (w79h252)</option>
        <option value="w154h64">Large label (w154h64)</option>
      </select>
    </div>

    <div class="field">
      <label class="kv-label">Fields</label>
      <div class="muted" style="font-size:12px; margin-bottom:4px;">
        Toggle what shows on the label. Quantity and Unit are combined.
      </div>
      <ul class="admin-sortable-list admin-required-list" style="gap:6px; padding:6px 8px;">
        {% set field_toggles = [
          ('include_name','Name', True),
          ('include_location','Location', True),
          ('include_bin','Bin', True),
          ('include_qty_unit','Qty + Unit', True),
          ('include_condition','Condition', False),
          ('include_cook_date','Cook date', False),
          ('include_use_by','Use-by', True),
          ('include_use_within','Use Within', False),
          ('include_qr','QR code', True)
        ] %}
        {% for key,label,checked in field_toggles %}
          <li class="admin-sortable-row" style="cursor:default;">
            <div class="admin-column-label">
              <div class="admin-column-title">{{ label }}</div>
            </div>
            <label class="switch">
              <input type="checkbox" name="{{ key }}" {% if checked %}checked{% endif %}>
              <span class="slider"></span>
            </label>
          </li>
        {% endfor %}
      </ul>
    </div>

    <div class="field">
      <label class="kv-label" for="font_scale">Font scale</label>
      <input
        class="input"
        id="font_scale"
        name="font_scale"
        type="number"
        step="0.1"
        min="0.6"
        max="1.4"
        value="1.0"
      >
      <p class="muted" style="font-size:12px;margin-top:4px;">
        1.0 = normal, lower = smaller text, higher = bigger.
      </p>
    </div>

    <div class="field">
      <label class="kv-label">Alignment</label>
      <label class="switch">
        <input type="checkbox" name="align_center">
        <span class="slider"></span>
      </label>
      <div class="muted" style="font-size:12px;">Center text (advanced)</div>
    </div>

    <div class="field">
      <label class="kv-label" for="printer_side">Printer side</label>
      <select class="input" id="printer_side" name="printer_side">
        <option value="auto" selected>Auto (based on label size)</option>
        <option value="left">Left roll</option>
        <option value="right">Right roll</option>
      </select>
      <div class="muted" style="font-size:12px; margin-top:4px;">
        For twin-roll printers (e.g., DYMO Twin). Use “Auto” to infer from media size.
      </div>
    </div>

    <div class="field">
      <label class="kv-label">Default?</label>
      <label style="font-size:12px;">
        <input type="checkbox" name="make_default"
          {% if not presets %}checked{% endif %}>
        Make this the default preset
      </label>
    </div>

    <div class="actions field--full">
      <button class="btn btn-primary" type="submit">
        Save preset
      </button>
    </div>
  </form>
</section>

{% endblock %}
