<!doctype html>
<html lang="en" data-root-path="{{ request.scope.get('root_path','') | replace('//','/') }}">
<head>
  <meta charset="utf-8">
  <meta name="viewport" content="width=device-width, initial-scale=1">
  <title>{% block title %}Pantrlytics{% endblock %}</title>

  <!-- Minimal fallback only (so page stays readable if CSS 404s).
       The real look comes from /static/styles.css below. -->
  <style>
    :root{
      --bg:#0b0b0d; --text:#e5e7eb; --link:#4dabf7;
    }
    html,body{
      margin:0;
      background:var(--bg);
      color:var(--text);
      font:14px/1.5 system-ui,-apple-system,Segoe UI,Roboto,Arial,sans-serif
    }
    a{color:var(--link);text-decoration:none}
    .container{max-width:1100px;margin:0 auto;padding:16px}
  </style>

  {% set rootp = request.scope.get('root_path','') %}
  <link rel="stylesheet"
      href="{{ (rootp ~ '/assets/styles.css?v=' ~ css_version) | replace('//','/') }}">
  <link rel="icon" type="image/png" href="{{ (rootp ~ '/assets/icon.png') | replace('//','/') }}">
  <link rel="alternate icon" type="image/svg+xml" href="{{ (rootp ~ '/assets/icon.svg') | replace('//','/') }}">
  <style>
    /* Mobile-only floating scan button */
    #scan-fab {
      position: fixed;
      right: 16px;
      bottom: 16px;
      z-index: 1100;
      width: 56px;
      height: 56px;
      border-radius: 999px;
      border: none;
      background: linear-gradient(135deg, #ff7a18, #ffb347);
      color: #0b0b0d;
      box-shadow: 0 10px 25px rgba(0,0,0,0.35);
      display: flex;
      align-items: center;
      justify-content: center;
      cursor: pointer;
    }
    #scan-fab svg { width: 26px; height: 26px; }
    /* Hide on larger screens */
    @media (min-width: 900px) { #scan-fab { display: none; } }

    /* Scanner overlay */
    #scan-overlay {
      position: fixed;
      inset: 0;
      background: rgba(0,0,0,0.65);
      backdrop-filter: blur(3px);
      z-index: 1200;
      display: none;
      align-items: center;
      justify-content: center;
      padding: 16px;
    }
    #scan-overlay[open] { display: flex; }
    .scan-sheet {
      background: var(--card, #121217);
      color: var(--text, #e5e7eb);
      border-radius: 16px;
      padding: 14px;
      width: min(480px, 100%);
      box-shadow: 0 15px 35px rgba(0,0,0,0.45);
      display: grid;
      gap: 10px;
    }
    .scan-header { display:flex; align-items:center; justify-content:space-between; gap:10px; }
    .scan-video-wrap {
      background:#000;
      border-radius:12px;
      overflow:hidden;
      position:relative;
      min-height:220px;
    }
    #scan-video { width:100%; height:100%; object-fit:cover; }
    .scan-status { font-size:13px; color: var(--muted, #9ca3af); }
    .scan-actions { display:flex; justify-content:flex-end; gap:8px; }
  </style>
</head>
<body>
  <script>
    // Apply theme class early to avoid flash
    (function() {
      const theme = localStorage.getItem('app_theme') || document.documentElement.dataset.theme || 'dark';
      document.documentElement.dataset.theme = theme;
    })();
  </script>
  <header class="app-header">
    <div class="container" style="display:grid; grid-template-columns:110px 1fr; grid-template-rows:auto auto; gap:10px 18px; align-items:center;">
      <div style="grid-row:1 / span 2; grid-column:1 / 2; align-self:center;">
        <a href="{{ url_for('index') }}" style="display:block;">
          <img src="{{ (request.scope.get('root_path','') ~ '/assets/icon.png') | replace('//','/') }}" alt="PantrLytics icon" width="100" height="100" style="display:block; border-radius:16px;">
        </a>
      </div>
      <div style="grid-row:1 / 2; grid-column:2 / 3;">
        <h1 class="app-title" style="margin:0;">
          <a href="{{ url_for('index') }}" style="display:inline-flex; align-items:baseline; gap:10px; text-decoration:none;">
            Pantrlytics
            <span style="font-size:14px; font-style:italic; color: var(--muted);">Your Mise en Place, Digitized.</span>
          </a>
        </h1>
      </div>
      <div style="grid-row:2 / 3; grid-column:2 / 3;">
        <nav class="nav" style="flex-wrap:wrap; gap:22px; padding-left:0; font-size:17px;">
          <a href="{{ url_for('index') }}">All Items</a>
          <a href="{{ url_for('new_item') }}">New Item</a>
          <a href="{{ url_for('label_designer') }}">Designer</a>
          <a href="{{ url_for('reports') }}">Reports</a>
          <a href="{{ url_for('admin') }}">Admin</a>
          <a href="{{ url_for('backup_page') }}">Backup</a>
        </nav>
      </div>
    </div>
  </header>

  <main class="container">
    {% block content %}{% endblock %}

    <!-- Modal -->
    <dialog id="app-modal">
      <form method="dialog" id="app-modal-close">
        <button class="btn btn-small btn-ghost" value="close" aria-label="Close dialog">
          ✕
        </button>
      </form>
      <div id="app-modal-body" class="modal-card"></div>
    </dialog>
  </main>
<script>
  const dlg  = document.getElementById('app-modal');
  const body = document.getElementById('app-modal-body');

  async function openModal(url) {
    try {
      const res  = await fetch(url, {
        headers: {
          "Accept": "text/html",
          "X-Requested-With": "fetch"
        }
      });
      const html = await res.text();
      body.innerHTML = html;

      if (typeof dlg.showModal === "function") {
        dlg.showModal();
      } else {
        dlg.setAttribute("open", "open");
      }

      const form = body.querySelector('form[data-edit-form]');
      if (form) {
        form.addEventListener('submit', async (e) => {
          e.preventDefault();
          const submitBtn = form.querySelector('button[type="submit"]') || form.querySelector('.btn-primary');
          const originalText = submitBtn ? submitBtn.textContent : '';
          if (submitBtn) { submitBtn.disabled = true; submitBtn.textContent = 'Saving…'; }
          const fd  = new FormData(form);
          let data = null;
          try {
            const res2 = await fetch(form.action, {
              method: 'POST',
              body: fd,
              headers: {
                "Accept": "application/json",
                "X-Requested-With": "fetch"
              }
            });
            const ct = res2.headers.get('content-type') || '';
            if (ct.includes('application/json')) {
              data = await res2.json();
            } else if (res2.ok) {
              // non-JSON but ok (e.g. redirect) -> reload
              window.location.reload();
              return;
            }
          } catch (err) {
            console.error(err);
          } finally {
            if (submitBtn) { submitBtn.disabled = false; submitBtn.textContent = originalText || 'Save'; }
          }

          if (data && data.ok) {
            closeModal();
            const urlObj = new URL(window.location.href);
            urlObj.searchParams.delete('edit');
            window.location.href = urlObj.toString();
          } else {
            alert('Save failed');
          }
        });
      }
    } catch (e) {
      console.error(e);
      alert('Failed to load editor.');
    }
  }

  function closeModal(){
    if (!dlg) return;
    if (typeof dlg.close === "function") {
      dlg.close();
    } else {
      dlg.removeAttribute("open");
    }
  }

  // ✅ Click outside the modal content to close
  if (dlg) {
    dlg.addEventListener('click', (event) => {
      // Only close if the user clicked the backdrop, not inside the card
      if (event.target === dlg) {
        closeModal();
      }
    });
  }

  window.openModal  = openModal;
  window.closeModal = closeModal;

  // Theme switcher listener (ties into admin radio)
  document.addEventListener('change', (e) => {
    const form = e.target.closest('#theme-form');
    if (!form) return;
    const toggle = form.querySelector('input[name="theme_toggle"]');
    const themeInput = form.querySelector('input[name="theme"]');
    const val = toggle && toggle.checked ? 'light' : 'dark';
    if (themeInput) themeInput.value = val;
    document.documentElement.dataset.theme = val;
    try { localStorage.setItem('app_theme', val); } catch (_e) {}
    form.submit();
  });

  // Simple required validation helper
  document.addEventListener('submit', (e) => {
    const form = e.target;
    if (!form.classList.contains('js-validate-required')) return;
    let valid = true;
    form.querySelectorAll('.field-error-message').forEach(el => el.remove());
    form.querySelectorAll('.field').forEach(f => f.classList.remove('field-error'));
    const requiredInputs = form.querySelectorAll('[required]');
    requiredInputs.forEach(inp => {
      if (!inp.value || (typeof inp.value === 'string' && !inp.value.trim())) {
        valid = false;
        const field = inp.closest('.field') || inp.parentElement;
        if (field) {
          field.classList.add('field-error');
          const msg = document.createElement('div');
          msg.className = 'field-error-message';
          msg.textContent = 'Required';
          field.appendChild(msg);
        }
      }
    });
    if (!valid) {
      e.preventDefault();
      e.stopPropagation();
    }
  });

  // File input filename display
  document.addEventListener('change', (e) => {
    const input = e.target;
    if (!(input instanceof HTMLInputElement)) return;
    if (input.type !== 'file') return;
    const wrapper = input.closest('.file-input');
    if (!wrapper) return;
    const label = wrapper.querySelector('.file-name');
    if (!label) return;
    const files = Array.from(input.files || []);
    if (!files.length) {
      label.textContent = 'No file chosen';
      return;
    }
    const names = files.slice(0,3).map(f => f.name).join(', ');
    label.textContent = files.length > 3 ? `${files.length} files selected (${names}…)` : names;
  });

  // -------- In-app QR scanner (mobile) --------
  (function(){
    const fab     = document.getElementById('scan-fab');
    const overlay = document.getElementById('scan-overlay');
    const videoEl = document.getElementById('scan-video');
    const statusEl= document.getElementById('scan-status');
    const closeBtn= document.getElementById('scan-close');
    if (!fab || !overlay || !videoEl) return;

    const rootPath = (document.documentElement.dataset.rootPath || '').replace(/\/+$/,'');
    let stream = null;
    let rafId = null;
    let detector = null;

    function setStatus(msg) {
      if (statusEl) statusEl.textContent = msg;
    }

    function hideOverlay() {
      if (overlay) {
        overlay.removeAttribute('open');
        overlay.setAttribute('hidden','hidden');
      }
    }

    async function stopScan() {
      if (rafId) cancelAnimationFrame(rafId);
      rafId = null;
      if (stream) {
        stream.getTracks().forEach(t => t.stop());
        stream = null;
      }
      if (videoEl) {
        videoEl.pause();
        videoEl.srcObject = null;
      }
      hideOverlay();
    }

    function handleResult(text) {
      stopScan();
      const trimmed = (text || '').trim();
      if (!trimmed) return;
      if (/^https?:\/\//i.test(trimmed)) {
        window.location.href = trimmed;
        return;
      }
      const serial = encodeURIComponent(trimmed);
      const base = rootPath || '';
      window.location.href = `${base}/item/by-serial/${serial}`;
    }

    async function detectLoop() {
      if (!detector || !videoEl || !stream) return;
      try {
        const results = await detector.detect(videoEl);
        if (results && results.length) {
          handleResult(results[0].rawValue || results[0].rawdata || results[0].rawData || results[0].rawtext || '');
          return;
        }
      } catch (err) {
        // Ignore "not found" type errors; log others
        if (console && err && !/NotFoundError/i.test(err.name || '')) console.debug(err);
      }
      rafId = requestAnimationFrame(detectLoop);
    }

    async function startScan() {
      try {
        if (!('BarcodeDetector' in window)) {
          alert('QR scanning not supported on this browser. Please use the system camera app.');
          return;
        }
        detector = new window.BarcodeDetector({ formats: ['qr_code', 'code_128', 'code_39', 'code_93', 'data_matrix'] });
      } catch (err) {
        console.error(err);
        alert('QR scanning not supported on this device.');
        return;
      }

      overlay.removeAttribute('hidden');
      overlay.setAttribute('open','open');
      setStatus('Starting camera…');

      try {
        stream = await navigator.mediaDevices.getUserMedia({
          video: { facingMode: { ideal: 'environment' } },
          audio: false
        });
      } catch (err) {
        console.error(err);
        setStatus('Camera permission needed. Please allow camera access.');
        setTimeout(stopScan, 1800);
        return;
      }

      videoEl.srcObject = stream;
      try { await videoEl.play(); } catch(_e){}
      setStatus('Point your camera at a label QR code.');
      rafId = requestAnimationFrame(detectLoop);
    }

    fab.addEventListener('click', (e) => {
      e.preventDefault();
      startScan();
    });
    if (closeBtn) {
      closeBtn.addEventListener('click', (e) => { e.preventDefault(); stopScan(); });
    }
    overlay.addEventListener('click', (e) => {
      if (e.target === overlay) stopScan();
    });
  })();
</script>
</body>

{% if scan_button %}
  <button id="scan-fab" aria-label="Scan QR">
    <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
      <path d="M4 4h5v2H6v3H4V4zM15 4h5v5h-2V6h-3V4zM4 15h2v3h3v2H4v-5zM18 15h2v5h-5v-2h3v-3zM7 12h2v2H7zM11 12h2v2h-2zM15 12h2v2h-2zM11 16h2v2h-2z"/>
    </svg>
  </button>
  <div id="scan-overlay" role="dialog" aria-modal="true" hidden>
    <div class="scan-sheet">
      <div class="scan-header">
        <div>
          <div style="font-weight:700;">Scan a label</div>
          <div class="scan-status" id="scan-status">Starting…</div>
        </div>
        <button class="btn btn-secondary btn-small" id="scan-close" type="button">Close</button>
      </div>
      <div class="scan-video-wrap">
        <video id="scan-video" playsinline></video>
      </div>
    </div>
  </div>
{% endif %}
</html>
